<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
		xmlns:ui="http://java.sun.com/jsf/facelets" 
		xmlns:h="http://java.sun.com/jsf/html" 
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:p="http://primefaces.org/ui"
		dir="#{_skyveContent.dir}">
    <f:view encoding="#{_skyveContent.encoding}">
		<f:metadata>
			<f:event type="preRenderView" listener="#{_skyveContent.preRender}" />
		</f:metadata>
		<h:head>
			<title>#{_skyveContent.i18n['page.contentUpload.title']}</title>
			<style>
				.ui-widget {
				    font-size: 12px !important;
				}
				.ui-fileupload-buttonbar {
					text-align: center;
				}
				.square {
					position: relative;
					width: 50%;
					padding-top: 10px;
				}
				.square:after {
					content: "";
					display: block;
					padding-bottom: 75%;
				}
				.content {
					position: absolute;
					width: 100%;
					height: 100%;
					padding-left: 50%;
				}
			</style>
			<link rel="stylesheet" href="croppie/croppie.css" />
			<script src="croppie/exif-min.js"></script>
			<script src="croppie/croppie-min.js"></script>
			<script type="text/javascript">
				var cropper = null;
				var fileName = null;
				var fileFormat = 'png';
				function readFile(input) {
					if (input.files) {
						if (input.files[0]) {
							var file = input.files[0];
							if (file.type == 'image/jpeg') {
								fileFormat = 'jpeg';
							}
							fileName = file.name + '.cropped.' + fileFormat;
							$('#cropperContainer').css({display: 'flex'});
							var reader = new FileReader();
							reader.onload = function (evt) {
								cropper.croppie('bind', {
									url: evt.target.result
								});
							}
							reader.readAsDataURL(file);
						}
			        }
			        else {
				        alert("You're browser doesn't support the FileReader API");
				    }
				}
				
				function uploadCropped(blob) {
					var formData = new FormData(document.getElementById('form'));
					formData.append('javax.faces.partial.ajax', 'true');
					formData.append('javax.faces.partial.execute', 'upload');
					formData.append('javax.faces.source', 'upload');
					formData.append('javax.faces.partial.render', 'messages');
					formData.append('upload', blob, fileName);

					$.ajax({
						type: 'POST',
						url: 'imageUpload.xhtml',
						data: formData,
						processData: false,
						contentType: false
					}).done(function(data, status, xhr) {
						PrimeFaces.ajax.Response.handle(data, status, xhr);
					});
				}
				
				$(document).ready(function() {
					$('#upload_input').on('change', function () {
						readFile(this);
					});

					cropper = $('#cropper').croppie({
						viewport: {
							width: 100,
							height: 100,
							type: 'square'
						},
						enableExif: true,
						enableResize: true,
						enableOrientation: true
					});
				});
			</script>
		</h:head>
		<h:body style="height:2000px">
			<h:form id="form" enctype="multipart/form-data" prependId="false">
				<h:inputHidden id="_c" value="#{_skyveContent.context}" />
				<h:inputHidden id="_b" value="#{_skyveContent.binding}" />
				<h:inputHidden id="_n" value="#{_skyveContent.contentBinding}" />
				<p:fileUpload id="upload"
								fileUploadListener="#{_skyveContent.handleFileUpload}" 
								accept="image/*"
								update="messages"
								multiple="false"
								fileLimit="1"
								fileLimitMessage="#{_skyveContent.i18n['page.contentUpload.error']}" />
			    <p:growl id="messages" showDetail="true" escape="false" />
				<div id="cropperContainer" style="display:none">
					<div class="square">
						<div id="cropper" class="content" />
					</div>
					<div style="width:25%;padding-right:10px" />
					<div style="display:flex;flex-direction:column;justify-content:center">
						<p:button style="margin-bottom:10px" type="button" icon="fa fa-rotate-left" title="Rotate Left" onclick="cropper.croppie('rotate',90);return false" />
						<p:button style="margin-bottom:10px" type="button" icon="fa fa-rotate-right" title="Rotate Right" onclick="cropper.croppie('rotate',-90);return false" />
						<p:button type="button" icon="fa fa-upload" title="Upload Cropped Image" onclick="cropper.croppie('result', {type: 'blob', size: 'original', format: fileFormat}).then(function(blob) {uploadCropped(blob)});return false" />
					</div>
				</div>
			</h:form>
		</h:body>
	</f:view>
</html>
