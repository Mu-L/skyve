<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    	xmlns:ui="http://java.sun.com/jsf/facelets"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:p="http://primefaces.org/ui"
		xmlns:pm="http://primefaces.org/mobile"
		xmlns:w="http://bizhub.com.au/ui"
		xmlns:pe="http://primefaces.org/ui/extensions"
		xmlns:pt="http://xmlns.jcp.org/jsf/passthrough">
    <f:view renderKitId="PRIMEFACES_MOBILE">
		<pe:importEnum type="org.skyve.web.WebAction" var="WebAction" allSuffix="ALL_ENUM_VALUES" />  
		<f:metadata>
			<f:viewParam name="i" value="#{inOutView.bizIdParameter}" />
			<f:event type="preRenderView" listener="#{inOutView.preRender}"/>
		</f:metadata>
		<ui:composition template="../phone/template.xhtml">
			<ui:param name="baseHref" value="#{inOutView.baseHref}" />
			<ui:param name="wildcatVersionComment" value="#{inOutView.wildcatVersionComment}" />
			<ui:define name="head">
				<link type="text/css" media="screen" rel="stylesheet" href="whosin/jquery.cropbox.css" />
				<script type="text/javascript" src="whosin/hammer.js"></script>
				<script type="text/javascript" src="whosin/jquery.mousewheel.js"></script>
				<script type="text/javascript" src="whosin/jquery.cropbox.js"></script>
			</ui:define>
			<ui:define name="pages">
				<pm:page id="inout">
					<pm:header title="In/Out - #{inOutView.currentBean['bizKey']}" fixed="true">
						<p:button value="Home" styleClass="ui-btn-left ui-btn-inline" icon="ui-icon-home" href="/" />
						<p:button value="Logout" styleClass="ui-btn-right ui-btn-inline" icon="ui-icon-gear" href="/loggedOut" />
					</pm:header>
					<pm:content>
						<h:form id="inoutForm">
							<w:view module="#{inOutView.bizModuleParameter}"
										document="#{inOutView.bizDocumentParameter}"
										managedBean="inOutView"
										type="phone" />
							<p:dataList id="inoutList"
											paginator="false"
											rows="10"
											value="#{inOutView.staff}"
											var="member"
											pt:data-inset="true">
								<f:facet name="header">
									Staff
								</f:facet>
								<f:attribute name="paginatorText" value="More..." />
								<p:column>
									<p:commandLink action="pm:staff" update=":staff:staffHeader :staff:staffForm">
										<h:outputText value="#{member.contact.name}" />
										<h:outputText value="#{member.getStatus().toDescription()}" style="float:right"/>
										<f:setPropertyActionListener value="#{member}" target="#{inOutView.selectedStaff}" />
									</p:commandLink>
								</p:column>
							</p:dataList>
						</h:form>
					</pm:content>
				</pm:page>
				<pm:page id="staff">
					<pm:header id="staffHeader" title="In/Out - #{inOutView.selectedStaff.bizKey}" fixed="true">
						<p:button value="Home" styleClass="ui-btn-left ui-btn-inline" icon="ui-icon-home" href="/" />
						<p:button value="Logout" styleClass="ui-btn-right ui-btn-inline" icon="ui-icon-gear" href="/loggedOut" />
					</pm:header>
					<pm:content>
						<h:form id="staffForm">
							<!-- This needs to be in here each time to get rerendered when the mobile poage is shown, not in head -->
							<script type="text/javascript">
							    geoLocate = function() {
							    	$(function(){PrimeFaces.cw("Growl","growl",{id:"growl",widgetVar:"growl",msgs:[{summary:'GeoLocating', detail: 'Please wait...', severity: 'info'}]});});
					                navigator.geolocation.getCurrentPosition(
					                    function(position) {
					                    	$(PrimeFaces.escapeClientId('staff:staffForm:location')).val(
												'POINT (' + position.coords.longitude + ' ' + position.coords.latitude + ')'
					                    	);
					    			    	$(function(){PrimeFaces.cw("Growl","growl",{id:"growl",widgetVar:"growl",msgs:[{summary:'GeoLocating', detail: 'Done', severity: 'info'}]});});
					                    },
					                    function(error) {
					    			    	$(function(){PrimeFaces.cw("Growl","growl",{id:"growl",widgetVar:"growl",msgs:[{summary:'GeoLocating', detail: error.message, severity: 'warn'}]});});
					                    },
					                    {
					                       enableHighAccuracy: true
					                    });
					            };
				
					            function readURL(input) {
					                if (input.files &amp;&amp; input.files[0]) {
					                    var reader = new FileReader();
					                    reader.onload = function (e) {
											$('#Photo').attr('src', e.target.result);
					                    }
					                    reader.readAsDataURL(input.files[0]);
					                }
					            }
				
					            $(function() {
									$('#PhotoButton').click(function() {
										$('#PhotoPicker').trigger('click');
											return false;
										});
							        $('#PhotoPicker').on('change', function(e) {
							            e.preventDefault();
							            if(this.files.length === 0) return;
										readURL(this);
							        });
						            $('#Photo').cropbox({width: 200, height: 200, zoom: 50, showControls: 'auto'}).on('cropbox',
											function(event, results, img) {
			//									alert(img.getDataURL());
			//			            			$('#download').attr('href', img.getDataURL());
											});
					            });
							</script>

							<!-- Place file upload in a div size 0 with no overflow -->
							<div style="width: 0; height: 0; overflow: hidden;">
								<input id="PhotoPicker" type="file" accept="image/*" pt:capture="camera" />
							</div>
							<button id="PhotoButton" class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-camera">
								Photo
							</button>
							<div style="width:100%;text-align:center">
								<img id="Photo" src="whosin/img.jpg" />					
							</div>
							<pm:field>
							    <p:outputLabel for="status" value="Status:" />
								<p:selectOneRadio id="status" value="#{inOutView.selectedStaff.status}" converter="SelectItemsBean">
									<f:selectItem itemLabel="In the Office" itemValue="inTheOffice" />
									<f:selectItem itemLabel="Out of the Office" itemValue="outOfTheOffice" />
									<f:selectItem itemLabel="On Leave" itemValue="onLeave" />
									<f:selectItem itemLabel="At Lunch" itemValue="atLunch" />
								</p:selectOneRadio>
							</pm:field>
							<h:inputHidden id="location" value="#{inOutView.selectedStaff.location}" converter="Geometry" />
							<button class="ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-icon-navigation"
										onclick="geoLocate(); return false">
								Set Current Location
							</button>
							<br/>
							<p:commandButton value="Save" 
												icon="ui-icon-check"
												action="#{inOutView.saveSelectedStaff}" 
												update=":inout:inoutForm:inoutList" />
						</h:form>
					</pm:content>
				</pm:page>
			</ui:define>
		</ui:composition>
	</f:view>
</html>
