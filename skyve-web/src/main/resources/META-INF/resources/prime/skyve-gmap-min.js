SKYVE.BizMap=function(){var a={};var c=new Wkt.Wkt();var b=function(g,d){if(g._refreshing){return}g._refreshing=true;var f="";if(g.loading==="lazy"){var e=g.webmap.getBounds();c.fromObject(e.getNorthEast());f="&_ne="+c.write();c.fromObject(e.getSouthWest());f+="&_sw="+c.write()}$.get(g.url+f,function(h){try{SKYVE.GMap.scatter(g,h,d,true)}finally{g._refreshing=false}})};return{create:function(f){var e={zoom:1,center:new google.maps.LatLng(0,0),mapTypeId:google.maps.MapTypeId.ROADMAP};var k=a[f.elementId];if(k){if(k.webmap){e.zoom=k.webmap.getZoom();e.center=k.webmap.getCenter();e.mapTypeId=k.webmap.getMapTypeId()}if(k._intervalId){clearInterval(k._intervalId);k._intervalId=null}}else{k={_objects:null,refreshTime:f.refreshTime,loading:f.loading,_refreshRequired:true,_refreshing:false,_intervalId:null,click:function(l,m){SKYVE.BizMap.click(this,l,m)},rerender:function(){b(this,false)},moduleName:f.moduleName,queryName:f.queryName,geometryBinding:f.geometryBinding,documentName:f.documentName,modelName:f.modelName};a[f.elementId]=k}var j=false;if(k.documentName){var g=k.moduleName+"_"+k.documentName+"_"+k.modelName;var i=sessionStorage.getItem(g);if(i){j=true;var h=JSON.parse(i);e.center=h.centre;e.zoom=h.zoom;sessionStorage.removeItem(g)}}else{var g=k.moduleName+"_"+k.queryName+"_"+k.geometryBinding;var i=sessionStorage.getItem(g);if(i){j=true;var h=JSON.parse(i);e.center=h.centre;e.zoom=h.zoom;sessionStorage.removeItem(g)}}k._objects={};k.infoWindow=new google.maps.InfoWindow({content:""});k.webmap=new google.maps.Map(SKYVE.PF.getByIdEndsWith(f.elementId)[0],e);if(f.showRefresh){SKYVE.GMap.refreshControls(k)}if(f.loading==="lazy"){google.maps.event.addListener(k.webmap,"zoom_changed",function(){if(!k._refreshing){b(k,false)}});google.maps.event.addListener(k.webmap,"dragend",function(){b(k,false)})}var d=SKYVE.Util.CONTEXT_URL+"map?";if(f.modelName){d+="_c="+f._c+"&_m="+f.modelName}else{if(f.queryName){d+="_mod="+f.moduleName+"&_q="+f.queryName+"&_geo="+f.geometryBinding}}k.url=d;b(k,(!j));if((k.refreshTime>0)&&k._refreshRequired){k._intervalId=setInterval(k.rerender.bind(k),k.refreshTime*1000)}return k},get:function(d){return a[d]},click:function(g,d,f){if(g.documentName){sessionStorage.setItem(g.moduleName+"_"+g.documentName+"_"+g.modelName,'{"centre":'+JSON.stringify(g.webmap.getCenter().toJSON())+',"zoom":'+g.webmap.getZoom()+"}")}else{sessionStorage.setItem(g.moduleName+"_"+g.queryName+"_"+g.geometryBinding,'{"centre":'+JSON.stringify(g.webmap.getCenter().toJSON())+',"zoom":'+g.webmap.getZoom()+"}")}var e=d.infoMarkup;e+='<br/><br/><input type="button" value="Zoom" onclick="window.location=\''+SKYVE.Util.CONTEXT_URL;e+="?m="+d.mod+"&d="+d.doc+"&i="+d.bizId+"'\"/>";if(d.getPosition){g.infoWindow.open(g.webmap,d);g.infoWindow.setContent(e)}else{if(d.getPath){g.infoWindow.setPosition(f.latLng);g.infoWindow.open(g.webmap);g.infoWindow.setContent(e)}}}}}();SKYVE.BizMapPicker=function(){var a={};var b=new Wkt.Wkt();return{create:function(f){var e={zoom:SKYVE.Util.mapZoom,center:SKYVE.GMap.centre(),mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}};var g=a[f.elementId];if(g){if(g.webmap){e.zoom=g.webmap.getZoom();e.center=g.webmap.getCenter();e.mapTypeId=g.webmap.getMapTypeId()}}else{g={_overlays:[],setFieldValue:function(h){var i=SKYVE.PF.getTextElement(d+"_value");i.val(h);i.change()}};a[f.elementId]=g}var d=SKYVE.PF.getByIdEndsWith(f.elementId).attr("id");g.webmap=new google.maps.Map(document.getElementById(d),e);if(!f.disabled){SKYVE.GMap.drawingTools(g);SKYVE.GMap.geoLocator(g)}SKYVE.GMap.clear(g);var c=SKYVE.PF.getTextElement(d+"_value");c.attr("readonly",true);SKYVE.GMap.scatterValue(g,c.val())}}}();